# -*- coding: utf-8 -*-
"""Customer Churn Prediction â€“ Real-Time ML Service.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1g_4zYVHsdi8OMcyvlhfcopXGhQNLbuTd
"""

import pandas as pd
import os

df = pd.read_csv("/content/WA_Fn-UseC_-Telco-Customer-Churn.csv")

df = df.dropna()
df['Churn'] = df['Churn'].map({'Yes':1, 'No':0})

# Create the 'data' directory if it doesn't exist
os.makedirs('data', exist_ok=True)
df.to_csv("data/processed.csv", index=False)

import pandas as pd
import joblib
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import f1_score
import os

df = pd.read_csv("data/processed.csv")

# Convert 'TotalCharges' to numeric, coercing errors to NaN and then dropping rows with NaN
df['TotalCharges'] = pd.to_numeric(df['TotalCharges'], errors='coerce')
df.dropna(inplace=True)

# Drop customerID column as it's an identifier and not a feature
df = df.drop("customerID", axis=1)

# Apply one-hot encoding to categorical features
df = pd.get_dummies(df, drop_first=True)

X = df.drop("Churn", axis=1)
y = df["Churn"]

X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42
)

model = RandomForestClassifier(
    n_estimators=300,
    max_depth=12,
    random_state=42
)
model.fit(X_train, y_train)

preds = model.predict(X_test)
print("F1 Score:", f1_score(y_test, preds))

# Create the 'model' directory if it doesn't exist
os.makedirs('model', exist_ok=True)
joblib.dump(model, "model/model.pkl")

from pydantic import BaseModel

class Customer(BaseModel):
    tenure: int
    monthly_charges: float
    total_charges: float

from fastapi import FastAPI
import joblib
import numpy as np
# The Customer class is already defined in a previous cell and available globally
# from app.schema import Customer
import time

app = FastAPI(title="ML Inference System")

model = joblib.load("model/model.pkl")

@app.get("/health")
def health():
    return {"status": "running"}

@app.post("/predict")
def predict(data: Customer):
    start = time.time()

    features = np.array([[
        data.tenure,
        data.monthly_charges,
        data.total_charges
    ]])

    prediction = model.predict(features)[0]
    latency = round(time.time() - start, 4)

    return {
        "prediction": int(prediction),
        "latency_sec": latency
    }

